{% extends "events/base.html" %}

{% load static %}
{% load crispy_forms_tags %}
{% load humanize %}

{% block page_heading %}
    <h1>Event management</h1>
{% endblock page_heading %}

{% block content %}
    {% if events_user_is_staff_for_future and events_user_is_staff_for_past %}

        <!-- Generate Event CSVs -->        
        <details>
            <summary>Create Event CSVs</summary>
            {% if event_csv_builder_form %}
                <div style="margin-left: 50px; margin-right: 50px; margin-top: 20px; margin-bottom: 20px;">
                    <p style="font-style: italic">
                        Select the fields you wish to include in the CSV
                    </p>
                    <form method="post" action="{% url 'events:generate_event_csv' %}">
                        {% csrf_token %}
                        {% crispy event_csv_builder_form %}
                        <input class="btn btn-primary" type="submit" value="Generate csv">
                    </form>
                    <br>
                </div>
            {% endif %}        
        </details>

        <div class="events-container">
            <h4>Events you are staff for</h4>
        </div>

        <div class="tabs">
            <button class="events-time-period-button tablink events-time-period-blue" onclick="openEvents(event, 'Past')" style="margin-bottom: 20px;">
                <b>Past</b>
            </button>
            <button class="events-time-period-button tablink" onclick="openEvents(event, 'Future')" style="margin-bottom: 20px;">
                <b>Future</b>
            </button>
        </div>
        
        <div id="Past" class="time">
            {% for event in events_user_is_staff_for_past %}
                <div class="card-header title-header align-middle">
                    <div class="row">
                        <div class="col-12 col-lg-9">
                            {% if event.organisers.all or event.series %}
                                <div class="mb-2">
                                    {% if event.series.logo %}
                                        <img src="{{ event.series.logo.url }}" class="img-inline" alt="{{ event.series.name }}">
                                    {% elif event.series.abbreviation %}
                                        <small class="text-muted">
                                            Part of {{ event.series.abbreviation }} series
                                        </small>
                                    {% endif %}
                                    {% for organiser in event.organisers.all %}
                                        <a href="{% url 'events:upcoming' %}?organisers={{ organiser.pk}}">
                                            {% if organiser.logo %}
                                                <img src="{{ organiser.logo.url }}" class="event-card-sponsor mr-3" alt="{{ organiser.name }}">
                                            {% else %}
                                                <small class="mr-4">
                                                    {{ organiser.name }}
                                                </small>
                                            {% endif %}
                                        </a>
                                    {% endfor %}
                                </div>
                            {% endif %}
                            <h4 class="mb-0">
                                <div>
                                    <a href="{{ event.get_absolute_url }}">
                                        {{ event.name }}
                                    </a>
                                </div>
                                <br>
                                <div>
                                    <a href="{% url 'events:event_management' event.pk %}" class="btn btn-sm btn-secondary float-left">
                                        Manage 
                                    </a>
                                </div>
                            </h4>
                        </div>
                        <div class="col text-left text-lg-right align-self-center">
                            {% if event.start|date:"j" != event.end|date:"j" %}
                                {% if event.start|date:"F" == event.end|date:"F" %}
                                    {{ event.start|date:"j" }}
                                {% else %}
                                    {{ event.start|date:"j F" }}
                                {% endif %}
                                to
                            {% endif %}
                            {{ event.end|date:" j F Y" }}<br>
                            <small class="text-muted">{{ event.start|naturaltime }}</small>
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
        
        <div id="Future" class="time" style="display:none">
            {% for event in events_user_is_staff_for_future %}
                <div class="card-header title-header align-middle">
                    <div class="row">
                        <div class="col-12 col-lg-9">
                            {% if event.organisers.all or event.series %}
                                <div class="mb-2">
                                    {% if event.series.logo %}
                                        <img src="{{ event.series.logo.url }}" class="img-inline" alt="{{ event.series.name }}">
                                    {% elif event.series.abbreviation %}
                                        <small class="text-muted">
                                            Part of {{ event.series.abbreviation }} series
                                        </small>
                                    {% endif %}
                                    {% for organiser in event.organisers.all %}
                                        <a href="{% url 'events:upcoming' %}?organisers={{ organiser.pk}}">
                                            {% if organiser.logo %}
                                                <img src="{{ organiser.logo.url }}" class="event-card-sponsor mr-3" alt="{{ organiser.name }}">
                                            {% else %}
                                                <small class="mr-4">
                                                    {{ organiser.name }}
                                                </small>
                                            {% endif %}
                                        </a>
                                    {% endfor %}
                                </div>
                            {% endif %}
                            <h4 class="mb-0">
                                <div>
                                    <a href="{{ event.get_absolute_url }}">
                                        {{ event.name }}
                                    </a>
                                </div>
                                <br>
                                <div>
                                    <a href="{% url 'events:event_management' event.pk %}" class="btn btn-sm btn-secondary float-left">
                                        Manage 
                                    </a>
                                </div>
                            </h4>
                        </div>
                        <div class="col text-left text-lg-right align-self-center">
                            {% if event.start|date:"j" != event.end|date:"j" %}
                                {% if event.start|date:"F" == event.end|date:"F" %}
                                    {{ event.start|date:"j" }}
                                {% else %}
                                    {{ event.start|date:"j F" }}
                                {% endif %}
                                to
                            {% endif %}
                            {{ event.end|date:" j F Y" }}<br>
                            <small class="text-muted">{{ event.start|naturaltime }}</small>
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>

    {% else %}
        <p class="text-center">
            You are not staffing any events.
        </p>
    {% endif %}
{% endblock content %}


{% block scripts %}
    <script>
        function openEvents(evt, time) {
        var i, x, tablinks;
        x = document.getElementsByClassName("time");
        for (i = 0; i < x.length; i++) {
            x[i].style.display = "none";
        }
        tablinks = document.getElementsByClassName("tablink");
        for (i = 0; i < x.length; i++) {
            tablinks[i].className = tablinks[i].className.replace(" events-time-period-blue", "");
        }
        document.getElementById(time).style.display = "block";
        evt.currentTarget.className += " events-time-period-blue";
        }
    </script>
    {% include "generic/map-javascript.html" %}
{% endblock scripts %}

